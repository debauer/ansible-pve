---
- name: Set correct ssh settings
  import_playbook: include/ssh.yml

- name: Base Playbook
  hosts: all,!meta
  gather_facts: true
  become: true


  tasks:
    - name: Basic roles
      tags: basic
      block:
        - name: Include role
          ansible.builtin.include_role:
            name: roles/basic/motd

        - name: Include role
          ansible.builtin.include_role:
            name: roles/basic/update
          when:
            - update_system is defined
            - update_system is truthy

        - name: Include role
          ansible.builtin.include_role:
            name: roles/basic/packages

        - name: Include role
          ansible.builtin.include_role:
            name: roles/basic/fail2ban

        - name: Include role
          ansible.builtin.include_role:
            name: roles/basic/apt
          when:
            - ansible_facts['os_family'] == "Debian"

    - name: User roles
      tags: user
      block:
        - name: Include role
          ansible.builtin.include_role:
            name: roles/user/user_add
          when:
            - (users | default([]) | length > 0) or (users_host | default([]) | length > 0)

        - name: Include role
          ansible.builtin.include_role:
            name: roles/user/user_secure
          when:
            - (users | default([]) | length > 0) or (users_host | default([]) | length > 0)

        - name: Include role
          ansible.builtin.include_role:
            name: roles/user/user_ssh_keys
          when:
            - (users | default([]) | length > 0) or (users_host | default([]) | length > 0)

        - name: Include role
          ansible.builtin.include_role:
            name: roles/user/user_shell
          when:
            - user_zsh is defined
            - user_zsh is truthy

    - name: Network roles
      tags: network
      block:
        - name: Include role
          ansible.builtin.include_role:
            name: roles/network/interfaces
          when: network_interfaces_interfaces is defined


    - name: Application roles
      tags: apps
      block:
        - name: Include role keycloak
          ansible.builtin.include_role:
            name: roles/apps/keycloak
          when: keycloak is defined and keycloak is truthy

        - name: Include role postgres
          ansible.builtin.include_role:
            name: roles/apps/postgres
          when: postgres is defined and postgres is truthy

        - name: Include gitlab role
          ansible.builtin.include_role:
            name: roles/apps/gitlab
          when: gitlab is defined and gitlab is truthy

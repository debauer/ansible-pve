---
- name: Collect Proxmox network facts from inventory host vars
  ansible.builtin.set_fact:
    ssh_basic_port_proxmox_nets: >-
      {{
        vars
        | dict2items
        | selectattr('key', 'match', '^proxmox_net[0-9]+$')
        | map(attribute='value')
        | list
      }}

- name: Detect if host has Proxmox guest network facts
  ansible.builtin.set_fact:
    ssh_basic_port_is_proxmox_guest: "{{ (ssh_basic_port_proxmox_nets | length) > 0 }}"

- name: Collect public networks from pve_bridge
  ansible.builtin.set_fact:
    ssh_basic_port_public_networks: >-
      {{
        pve_bridge | default({})
        | dict2items
        | selectattr('value.public', 'defined')
        | selectattr('value.public')
        | map(attribute='value.networks')
        | flatten
        | select('defined')
        | list
      }}

- name: Collect guest IP/CIDR values
  ansible.builtin.set_fact:
    ssh_basic_port_guest_ips: >-
      {{
        (
          ssh_basic_port_proxmox_nets
          | selectattr('ip', 'defined')
          | map(attribute='ip')
          | list
        )
        +
        (
          ssh_basic_port_proxmox_nets
          | selectattr('ip6', 'defined')
          | map(attribute='ip6')
          | reject('equalto', 'auto')
          | list
        )
      }}

- name: Debug input data
  ansible.builtin.debug:
    msg:
      host: "{{ inventory_hostname }}"
      is_proxmox_guest: "{{ ssh_basic_port_is_proxmox_guest }}"
      proxmox_nets_count: "{{ ssh_basic_port_proxmox_nets | length }}"
      guest_ips: "{{ ssh_basic_port_guest_ips }}"
      public_networks: "{{ ssh_basic_port_public_networks }}"
  when:
    - ssh_basic_port_debug | bool
    - ssh_basic_port_is_proxmox_guest

- name: Detect public network attachment (subnet-aware)
  ansible.builtin.command:
    argv:
      - python3
      - -c
      - |
        import ipaddress
        import json
        import sys

        guest_ips = json.loads(sys.argv[1])
        public_nets_raw = json.loads(sys.argv[2])

        public_nets = []
        for value in public_nets_raw:
            if not value:
                continue
            try:
                if "/" in value:
                    public_nets.append(ipaddress.ip_network(value, strict=False))
                elif ":" in value:
                    public_nets.append(ipaddress.ip_network(f"{value}/128", strict=False))
                else:
                    public_nets.append(ipaddress.ip_network(f"{value}/32", strict=False))
            except ValueError:
                continue

        has_public = False
        for value in guest_ips:
            if not value:
                continue
            try:
                ip_value = ipaddress.ip_interface(value).ip
            except ValueError:
                continue

            for public_net in public_nets:
                if ip_value.version == public_net.version and ip_value in public_net:
                    has_public = True
                    break

            if has_public:
                break

        print(json.dumps({"has_public_network": has_public}))
      - "{{ ssh_basic_port_guest_ips | to_json }}"
      - "{{ ssh_basic_port_public_networks | to_json }}"
  register: ssh_basic_port_network_check
  changed_when: false
  check_mode: false

- name: Set public network attachment fact
  ansible.builtin.set_fact:
    ssh_basic_port_has_public_network: >-
      {{
        (ssh_basic_port_network_check.stdout | from_json).has_public_network
      }}
  check_mode: false

- name: Resolve connection target and port
  ansible.builtin.set_fact:
    ssh_basic_port_is_internal_only: >-
      {{
        ssh_basic_port_is_proxmox_guest
        and not ssh_basic_port_has_public_network
      }}
    ssh_basic_port_proxy_host: >-
      {{
        (
          pve_bridge | default({})
          | dict2items
          | selectattr('value.proxy', 'defined')
          | map(attribute='value.proxy')
          | list
          | first
        )
        | default(ssh_basic_port_proxy_host_default)
      }}
  check_mode: false

- name: Extract primary IPv4 for port mapping
  ansible.builtin.set_fact:
    ssh_basic_port_primary_ipv4: >-
      {{
        (
          ssh_basic_port_proxmox_nets
          | selectattr('ip', 'defined')
          | map(attribute='ip')
          | select('match', '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$')
          | map('regex_replace', '/[0-9]+$', '')
          | list
          | first
        )
        | default('')
      }}
  when: ssh_basic_port_is_internal_only
  check_mode: false


- name: Ensure internal-only guests have an IPv4 address for port mapping
  ansible.builtin.assert:
    that:
      - ssh_basic_port_primary_ipv4 | length > 0
    fail_msg: >-
      Cannot resolve SSH port from IPv4 for {{ inventory_hostname }}.
      Internal-only guests need an IPv4 address in proxmox_net*.
  when:
    - ssh_basic_port_is_internal_only
  check_mode: false

- name: Apply ansible_ssh_common_args # noqa: var-naming
  ansible.builtin.set_fact:
    ansible_host: "{{ ssh_basic_proxy_host }}"
    ansible_ssh_common_args: '-o ProxyCommand="openssl s_client -quiet -connect {{ ssh_basic_proxy_host }}:{{ ssh_basic_proxy_port }} -servername {{ ssh_basic_port_primary_ipv4 }}"'
  when:
    - ssh_basic_port_is_proxmox_guest
    - ssh_basic_port_primary_ipv4 is defined
  check_mode: false

- name: Debug resolved SSH target
  ansible.builtin.debug:
    msg:
      host: "{{ inventory_hostname }}"
      has_public_network: "{{ ssh_basic_port_has_public_network | default(false) }}"
      internal_only: "{{ ssh_basic_port_is_internal_only | default(false) }}"
      is_proxmox_guest: "{{ ssh_basic_port_is_proxmox_guest }}"
      ansible_port: "{{ ansible_port | default('')}}"
      ansible_host: "{{ ansible_host | default('')}}"
      inventory_hostname: "{{ inventory_hostname | default('')}}"
      primary_ipv4: "{{ ssh_basic_port_primary_ipv4 | default('') }}"
      ansible_ssh_common_args: "{{ ansible_ssh_common_args | default('') }}"
      ansible_python_interpreter: "{{ ansible_python_interpreter | default('') }}"
  when:
    - ssh_basic_port_debug | bool
    - ssh_basic_port_is_proxmox_guest

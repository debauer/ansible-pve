---
- name: Validate target OS
  ansible.builtin.assert:
    that:
      - ansible_facts["os_family"] == "Debian"
      - ansible_facts["distribution"] == "Debian"
    fail_msg: This role currently supports Debian only.

- name: Validate Debian release
  ansible.builtin.assert:
    that:
      - ansible_facts["distribution_major_version"] | int >= 13
    fail_msg: This role requires Debian 13 (Trixie) or newer.

- name: Install apt prerequisites
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - openssh-server
      - tzdata
      - perl
    state: present
    update_cache: true

- name: Ensure apt keyring directory exists
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Download GitLab repository key
  ansible.builtin.get_url:
    url: "{{ gitlab_repo_key_url }}"
    dest: "{{ gitlab_repo_keyring_path }}"
    owner: root
    group: root
    mode: "0644"
    force: true

- name: Configure GitLab apt repository
  ansible.builtin.apt_repository:
    repo: "{{ gitlab_repo_apt_entry }}"
    filename: "gitlab-{{ gitlab_edition }}"
    state: present
    update_cache: true

- name: Install GitLab package
  ansible.builtin.apt:
    name: "gitlab-{{ gitlab_edition }}"
    state: "{{ gitlab_package_state }}"
  environment:
    EXTERNAL_URL: "{{ gitlab_external_url }}"
  failed_when: false

- name: Validate Keycloak OAuth configuration
  ansible.builtin.assert:
    that:
      - gitlab_oauth_keycloak_issuer | length > 0
      - gitlab_oauth_keycloak_client_id | length > 0
      - gitlab_oauth_keycloak_client_secret | length > 0
    fail_msg: >-
      Set gitlab_oauth_keycloak_issuer, gitlab_oauth_keycloak_client_id and
      gitlab_oauth_keycloak_client_secret when gitlab_oauth_keycloak_enable is true.
  when: gitlab_oauth_keycloak_enable | bool

- name: Configure /etc/gitlab/gitlab.rb
  ansible.builtin.template:
    src: gitlab.rb
    dest: /etc/gitlab/gitlab.rb
    owner: root
    group: root
    mode: "0600"
#  notify:
#    - Gitlab reconfigure
#    - Restart gitlab

#- name: Ensure GitLab service is enabled and running
#  ansible.builtin.service:
#    name: "{{ gitlab_service_name }}"
#    enabled: true
#    state: started
#  when: gitlab_manage_service#

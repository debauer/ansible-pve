---
- name: Resolve Prometheus architecture
  ansible.builtin.set_fact:
    prometheus_arch: "{{ prometheus_arch_map[ansible_architecture] | default(ansible_architecture) }}"

- name: Query latest Prometheus release metadata from GitHub
  ansible.builtin.uri:
    url: "https://api.github.com/repos/{{ prometheus_repo }}/releases/latest"
    method: GET
    return_content: true
    headers:
      Accept: application/vnd.github+json
  register: prometheus_latest_release
  changed_when: false
  when: prometheus_version == "latest"

- name: Resolve target Prometheus version
  ansible.builtin.set_fact:
    prometheus_target_version: >-
      {{
        (
          prometheus_latest_release.json.tag_name
          if prometheus_version == "latest"
          else prometheus_version
        ) | regex_replace('^v', '')
      }}
    prometheus_target_tag: >-
      {{
        (
          prometheus_latest_release.json.tag_name
          if prometheus_version == "latest"
          else ("v" + (prometheus_version | regex_replace('^v', '')))
        )
      }}

- name: Build Prometheus archive name
  ansible.builtin.set_fact:
    prometheus_archive_name: "prometheus-{{ prometheus_target_tag }}.linux-{{ prometheus_arch }}.tar.gz"

- name: Resolve Prometheus archive URL from latest release metadata
  ansible.builtin.set_fact:
    prometheus_archive_url: >-
      {{
        prometheus_latest_release.json.assets
        | selectattr('name', 'equalto', prometheus_archive_name)
        | map(attribute='browser_download_url')
        | first
        | default('')
      }}
  when: prometheus_version == "latest"

- name: Resolve Prometheus archive URL from static release path
  ansible.builtin.set_fact:
    prometheus_archive_url: >-
      https://github.com/{{ prometheus_repo }}/releases/download/{{ prometheus_target_tag }}/{{ prometheus_archive_name }}
  when: prometheus_version != "latest"

- name: Ensure Prometheus archive URL could be resolved
  ansible.builtin.assert:
    that:
      - prometheus_archive_url | length > 0
    fail_msg: >-
      Could not resolve Prometheus archive URL for tag {{ prometheus_target_tag }}
      and architecture {{ prometheus_arch }}.

- name: Check installed Prometheus version
  ansible.builtin.command: "{{ prometheus_bin_dir }}/prometheus --version"
  register: prometheus_installed_version_cmd
  changed_when: false
  failed_when: false

- name: Parse installed Prometheus version
  ansible.builtin.set_fact:
    prometheus_installed_version: >-
      {{
        (
          prometheus_installed_version_cmd.stdout
          | default('')
          | regex_findall('version\\s+([0-9]+\\.[0-9]+\\.[0-9]+)')
          | first
        ) | default('')
      }}

- name: Decide if Prometheus update is required
  ansible.builtin.set_fact:
    prometheus_update_required: "{{ prometheus_installed_version != prometheus_target_version }}"

- name: Show Prometheus version check
  ansible.builtin.debug:
    msg:
      installed_version: "{{ prometheus_installed_version | default('not installed') }}"
      latest_or_target_version: "{{ prometheus_target_version }}"
      update_required: "{{ prometheus_update_required }}"

- name: Ensure Prometheus group exists
  ansible.builtin.group:
    name: "{{ prometheus_group }}"
    system: true
  when: prometheus_create_user

- name: Ensure Prometheus user exists
  ansible.builtin.user:
    name: "{{ prometheus_user }}"
    system: true
    create_home: false
    shell: /usr/sbin/nologin
    group: "{{ prometheus_group }}"
  when: prometheus_create_user

- name: Ensure Prometheus directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - path: "{{ prometheus_install_dir }}"
      owner: root
      group: root
      mode: "0755"
    - path: "{{ prometheus_config_dir }}"
      owner: root
      group: root
      mode: "0755"
    - path: "{{ prometheus_data_dir }}"
      owner: "{{ prometheus_user }}"
      group: "{{ prometheus_group }}"
      mode: "0755"

- name: Download Prometheus release archive
  ansible.builtin.get_url:
    url: "{{ prometheus_archive_url }}"
    dest: "/tmp/{{ prometheus_archive_name }}"
    mode: "0644"
  when: prometheus_update_required

- name: Extract Prometheus release archive
  ansible.builtin.unarchive:
    src: "/tmp/{{ prometheus_archive_name }}"
    dest: /tmp
    remote_src: true
  when: prometheus_update_required

- name: Install Prometheus binaries
  ansible.builtin.copy:
    src: "/tmp/prometheus-{{ prometheus_target_tag }}.linux-{{ prometheus_arch }}/{{ item }}"
    dest: "{{ prometheus_bin_dir }}/{{ item }}"
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  loop:
    - prometheus
    - promtool
  when: prometheus_update_required
  notify: Restart prometheus

- name: Install Prometheus console assets
  ansible.builtin.copy:
    src: "/tmp/prometheus-{{ prometheus_target_tag }}.linux-{{ prometheus_arch }}/{{ item }}"
    dest: "{{ prometheus_install_dir }}/"
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  loop:
    - consoles
    - console_libraries
  when: prometheus_update_required
  notify: Restart prometheus

- name: Render Prometheus config
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/prometheus.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart prometheus

- name: Render Prometheus systemd service
  ansible.builtin.template:
    src: prometheus.service.j2
    dest: "/etc/systemd/system/{{ prometheus_service_name }}.service"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart prometheus

- name: Ensure Prometheus service is enabled and started
  ansible.builtin.systemd:
    name: "{{ prometheus_service_name }}"
    enabled: true
    state: started

- name: Clean temporary Prometheus release files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/{{ prometheus_archive_name }}"
    - "/tmp/prometheus-{{ prometheus_target_tag }}.linux-{{ prometheus_arch }}"
  when: prometheus_update_required

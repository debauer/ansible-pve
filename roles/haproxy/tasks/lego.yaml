---

- name: Ensure lego directory exists
  ansible.builtin.file:
    path: "{{ haproxy_lego_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy lego hook script
  ansible.builtin.template:
    src: deploy-hook.sh
    dest: /usr/local/bin/lego-deploy-hook.sh
    mode: "0755"
    owner: root
    group: root

- name: Install systemd service for each domain
  ansible.builtin.template:
    src: lego-cert.service
    dest: "/etc/systemd/system/lego-{{ item.name }}.service"
    owner: root
    group: root
    mode: "0644"
  vars:
    service_name: "{{ item.name }}"
  loop: "{{ haproxy_all_services }}"
  notify: Reload systemd

- name: Install systemd timer for each domain
  ansible.builtin.template:
    src: lego-cert.timer
    dest: "/etc/systemd/system/lego-{{ item.name }}.timer"
    owner: root
    group: root
    mode: "0644"
  vars:
    service_name: "{{ item.name }}"
  loop: "{{ haproxy_all_services }}"
  notify: Reload systemd

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Enable and start timers
  ansible.builtin.systemd:
    name: "lego-{{ item.name }}.timer"
    enabled: true
    state: started
  loop: "{{ haproxy_all_services }}"


- name: Check if certificate already exists
  ansible.builtin.stat:
    path: "{{ haproxy_cert_path }}/{{ item.name }}.pem"
  loop: "{{ haproxy_all_services }}"
  register: haproxy_cert_stat

- name: Run initial certificate issuance for missing domains
  ansible.builtin.command: >
    lego
    --domains {{ item.item.name }}
    --path {{ haproxy_lego_path }}
    --http
    --http.port 127.0.0.1:{{ haproxy_lego_http_port }}
    --accept-tos
    --pem
    --email {{ haproxy_cert_email }}
    run
    --run-hook /usr/local/bin/lego-deploy-hook.sh
  loop: "{{ haproxy_cert_stat.results }}"
  when: not item.stat.exists
  args:
    creates: "{{ haproxy_cert_path }}/{{ item.item.name }}.pem"

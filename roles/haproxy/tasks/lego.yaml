---

- name: Ensure lego directory exists
  ansible.builtin.file:
    path: "{{ haproxy_lego_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy lego hook script
  ansible.builtin.template:
    src: deploy-hook.sh
    dest: /usr/local/bin/lego-deploy-hook.sh
    mode: '0755'

- name: Install systemd service for each domain
  ansible.builtin.template:
    src: lego-cert.service
    dest: "/etc/systemd/system/lego-{{ item.name }}.service"
  loop: "{{ haproxy_all_services }}"
  notify: Reload systemd

- name: Install systemd timer for each domain
  ansible.builtin.template:
    src: lego-cert.timer
    dest: "/etc/systemd/system/lego-{{ item.name }}.timer"
  loop: "{{ haproxy_all_services }}"
  notify: reload systemd

- name: Flush handlers
  meta: flush_handlers

- name: Enable and start timers
  ansible.builtin.systemd:
    name: "lego-{{ item.name }}.timer"
    enabled: true
    state: started
  loop: "{{ haproxy_all_services }}"


- name: Check if certificate already exists
  stat:
    path: "{{ haproxy_cert_path }}/{{ item.name }}.crt"
  loop: "{{ haproxy_all_services }}"
  register: cert_stat

# - name: Run initial certificate issuance for missing domains
#   ansible.builtin.command: >
#     lego
#     --domains {{ item.item.name }}
#     --path {{ haproxy_lego_path }}
#     --http
#     --http.port 127.0.0.1:{{ haproxy_lego_http_port }}
#     --accept-tos
#     --pem
#     --email {{ haproxy_cert_email }}
#     run
#     --run-hook /usr/local/bin/lego-deploy-hook.sh
#   loop: "{{ cert_stat.results }}"
#   when: not item.stat.exists
